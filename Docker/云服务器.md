## 使用须知

![image-20231120092259178](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20231120092259178.png)

- 选择0M带宽不能访问公网（不分配公网IP），如需分配公网IP请增加带宽值。
- 云服务器ECS默认不开启虚拟内存如您需要使用请登录云服务器内部操作。[Linux开启swap（虚拟内存）](https://help.aliyun.com/document_detail/42534.html?spm=5176.6660585.vm-content.1.72b77992PbRdlu)、[Windows虚拟内存的设置](https://help.aliyun.com/document_detail/40995.html)
- 若您购买了数据盘，请先挂载后使用。[Linux操作系统挂载数据盘方法](https://help.aliyun.com/document_detail/25426.html?spm=a2c4g.11186623.0.0.586f9b85Lf4fU7)、[Windows操作系统挂载数据盘方法](https://help.aliyun.com/document_detail/25418.html?spm=a2c4g.11186623.0.0.586f9b85X8N4sr)
- 如您需要修改登录密码，请再ECS控制台对订购实例进行“重置密码“操作。请查看[操作指南](https://help.aliyun.com/document_detail/25439.html)
- 如网站用于web访问，请及时备案。如需帮助，请查看[备案专区](http://beian.aliyun.com/)
- 阿里云会不定期为您推送活动优惠以及业务通知，如需关闭消息或设置其他人接收消息，请前往 [消息中心](https://notifications.console.aliyun.com/#/subscribeMsg)进行管理
- ECS使用中遇到环境部署、安全检测、服务器加速等问题，需要管理工具帮助，请查看[软件市场](http://market.aliyun.com/software)
- 如您需要随时获取ECS资源信息，信息实时监控，请下载[阿里云APP](https://www.aliyun.com/aliyunapp/web/download)
- 我们为您提供了专业免费的[第三方软件安装教程](https://smartservice.console.aliyun.com/service/service-center?accounttraceid=7e69e60d30a0463b99c1be88ef6375bcgita)，包含MySQL、宝塔、WordPress、Nginx等十余款常用软件，还可提问安装过程中遇到的异常问题。如无法自助完成安装，可购买[一对一专家服务](https://www.aliyun.com/service/one-to-one_expert_service)

## 免密登陆

1. 安装 `Remote - SSH` 插件，即可在 VSCode 中进行配置

2. 配置别名快速登录：ssh-config

   ```bash
   Host lyn
     HostName xx.xx.xx.xx
     User root
   
   # 就可以直接登陆了（需要输入密码）
   $ ssh lyn
   ```

3. 修改本地 config

   ```bash
   # 提示你输入密码，成功后可以直接 ssh 登陆
   $ ssh-copy-id lyn
   
   # 就可以直接登陆了（无需输入密码）
   $ ssh lyn
   ```


## 自动化部署环境

### 安装Java

Jenkins 本身是依赖 Java 的，所以我们需要先安装 Java 环境

- 注意：最新版本 Jenkins 需要使用 11-17 版本的 Java
- 由于我使用的是 Alibaba Cloud Linux 3.2104 LTS 64位，就安装了 java-17-alibaba-dragonwel

```bash
$ dnf search java-17
$ dnf install java-17-alibaba-dragonwell.x86_64
```

如果下载的非最新版 Jenkins 可以安装 Java1.8 版本

```bash
$ dnf search java-1.8 
$ dnf install java-1.8.0-openjdk.x86_64
```

使用 dnf 安装的，很难找到 jdk 安装的位置，会有些小问题。还是推荐在官网下载，手动配置环境变量：[https://www.oracle.com/java/technologies/download](https://www.oracle.com/java/technologies/download)

- jdk8，需要先注册 Oracle 账号才能下载，官网下载还是很快的

![image-20231121164201283](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20231121164201283.png)

```bash
$ tar -zxvf jdk-17_linux-x64_bin.tar.gz
$ tar -zxvf jdk-8u391-linux-x64.tar.gz
$ pwd
/home/software/jdk-17.0.9/
/home/software/jdk1.8.0_391/
```

修改环境变量文件

```bash
# export JAVA_HOME=/home/software/jdk-17.0.9
export JAVA_HOME=/home/software/jdk1.8.0_391
export PATH=$JAVA_HOME/bin:$PATH
```

需要对应版本了，修改文件重新加载环境变量即可

```bash
$ source /etc/profile
```

### 安装Jenkins

```bash
$ dnf search jenkins
Last metadata expiration check: 0:29:36 ago on Mon 20 Nov 2023 08:58:40 AM CST.
=================================== Name & Summary Matched: jenkins ===================================
python3-jenkins.noarch : Python bindings for the remote Jenkins API
```

因为 Jenkins 本身是没有在 dnf 的软件仓库包中的，所以我们需要连接 Jenkins 仓库：

- wget 是 Linux 中下载文件的一个工具，-O 表示输出到某个文件夹并且命名为什么文件
- 命令如有变动直接参考官网说明即可：[https://pkg.origin.jenkins.io/redhat-stable/](https://pkg.origin.jenkins.io/redhat-stable/)

```bash
$ wget –O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo
$ mv jenkins.repo /etc/yum.repos.d/
```

根据对应 repo 就可以使用 dnf 进行安装了，但是安装是有认证的，需要使用 rpm 导入 GPG 密钥以确保软件合法

```bash
$ rpm --import https://pkg.jenkins.io/redhat/jenkins.io.key
# 或者
$ rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key
```

之后编辑一下 jenkins.repo

```bash
$ vim /etc/yum.repos.d/jenkins.repo
```

将 `http://pkg.jenkins.io/redhat-stable` 的 `-stable` 删除掉

```bash
[jenkins]
name=Jenkins-stable
baseurl=http://pkg.jenkins.io/redhat
gpgcheck=1
```

安装 Jenkins

```bash
$ dnf install jenkins --nogpgcheck
```

启动 Jenkins 服务

```bash
$ systemctl start jenkins
$ systemctl stop jenkins
$ systemctl status jenkins
$ systemctl enable jenkins
```

修改 Jenkins 端口

- 默认端口为 8080，我要改为 8081

```bash
$ cd /usr/lib/systemd/system
$ vim jenkins.service
```

![image-20231120102726327](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20231120102726327.png)

重新加载配置文件

```bash
$ systemctl daemon-reload
$ systemctl restart jenkins
```

直接访问 Jenkins 是无法展示页面的，需要将其加入到安全组中

![image-20231120103102460](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20231120103102460.png)

打开浏览器，输入 IP + 对应端口

获取输入管理员密码，解锁 Jenkins

```bash
$ cat /var/lib/jenkins/secrets/initialAdminPassword
fc53e288a4ac429baa33b44b412dd7a1
```

安装推荐插件即可

![image-20231120103330881](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20231120103330881.png)

### 安装Nginx

安装 Nginx，或者去官网直接下载

- [https://nginx.org/en/download.html](https://nginx.org/en/download.html)

```bash
$ dnf install nginx
```

启动 Nginx

```bash
$ systemctl start nginx
```

### 安装Git

```bash
$ dnf install git-all
```

> [Linux下安装GitLab仓库，史上最详细的教程来啦~](https://blog.csdn.net/smilehappiness/article/details/106353324)

我的云服务器小于这个配置...

![image-20231120112129257](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20231120112129257.png)

### 安装Maven

去官网下载或者使用 wget 下载到指定目录

- [https://maven.apache.org/download.cgi](https://maven.apache.org/download.cgi)

```bash
$ wget --no-check-certificate https://dlcdn.apache.org/maven/maven-3/3.9.5/binaries/apache-maven-3.9.5-bin.tar.gz
```

并解压 maven 包

```bash
$ tar -zxvf apache-maven-3.9.5-bin.tar.gz -C ./
$ pwd
/home/software/apache-maven-3.9.5
```

配置环境变量

- 注意：Maven 是基于 jdk 的，所以一定要确保你 jdk 已经装好

```bash
$ vim /etc/profile
export MAVEN_HOME=/home/software/apache-maven-3.9.5
export PATH=$MAVEN_HOME/bin:$PATH
```

重新加载环境变量

```bash
$ source /etc/profile
```

配置镜像源

```bash
$ vim $MAVEN_HOME/conf/settings.xml
<mirror>
 <id>alimaven</id>
 <name>aliyun maven</name>
 <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
 <mirrorOf>central</mirrorOf>
</mirror>
```

之后就可以直接打包了

- 默认没有配置存放路径，本地仓库会在 `/root/.m2/repository/`

```bash
$ mvn clean install
```

### 安装Tomcat

去官网下载或者使用 wget 下载到指定目录

- [https://tomcat.apache.org/download-90.cgi](https://tomcat.apache.org/download-90.cgi)

解压 tomcat 包

```bash
$ tar -zxvf apache-tomcat-9.0.55.tar.gz
$ pwd
/home/software/apache-tomcat-9.0.55
```

配置环境变量

```bash
$ vim /etc/profile
export TOMCAT_HOME=/home/software/apache-tomcat-9.0.55
export PATH=$TOMCAT_HOME/bin:$PATH
```

重新加载环境变量

```bash
$ source /etc/profile
```

## 其他环境

### 安装Docker

把 yum 包更新到最新，**不要随意更新**，因为我目前是新环境

```bash
$ yum update
```

安装软件包

```bash
$ yum install -y yum-utils device-mapper-persistent-data lvm2
```

设置 yum 源

```bash
$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

查看所有仓库中所有 docker 版本，并选择特定版本安装

```bash
$ yum list docker-ce --showduplicates | sort -r
```

安装 docker

```bash
$ yum install -y docker-ce-24.0.6
```

启动 docker

```bash
$ systemctl start docker
```

### 安装PostgreSQL

> [Linux下PostgreSQL安装部署详细步骤](https://blog.csdn.net/weixin_43230682/article/details/108403642)

安装方法参考官方文档：[https://www.postgresql.org/download/linux/redhat/](https://www.postgresql.org/download/linux/redhat/)

部署目录

| 名称             | 目录位置                    |
| ---------------- | --------------------------- |
| PG数据库安装目录 | /home/postgres/FlyingDB15.4 |
| PG数据库数据目录 | /home/postgres/pgdata       |
| PG数据库日志目录 | /home/postgres/pgdata/log   |

创建 postgres 系统用户

```bash
(root)
$ useradd -m postgres
$ passwd postgres
postgres@123

$ cat /etc/passwd | grep /bin/bash
root:x:0:0:root:/root:/bin/bash
postgres:x:1000:1000::/home/postgres:/bin/bash
```

切换到 postgres 用户，上传数据库包，并解压数据库包

```bash
(postgres)
$ pwd
/home/postgres
$ mkdir FlyingDB15.4
$ tar -zxvf FlyingDB15.4.tar.gz -C FlyingDB15.4/
$ mkdir pgdata
$ chmod 0700 pgdata
```

**搭建主库**

1. 配置环境变量

   ```bash
   $ vim ~/.bash_profile
   export PGHOME=/home/postgres/FlyingDB15.4
   export LD_LIBRARY_PATH=$PGHOME/lib:$LD_LIBRARY_PATH
   export PATH=$PGHOME/bin:$PATH:$HOME/.local/bin:$HOME/bin
   export PGDATA=/home/postgres/pgdata
   export PGDATABASE=postgres
   export PGUSER=postgres
   export PGPORT=5432
   export PGHOST=localhost
   export MANPATH=$PGHOME/share/man:$MANPATH
   export LANG=en_US.utf8
   export DATE=`date +"%Y%m%d%H%M"`
   
   $ source ~/.bash_profile
   ```

2. 初始化数据库

   ```bash
   $ initdb -D /home/postgres/pgdata -E UTF8 --locale=C -U postgres
   ```

   ![image-20231122100831718](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20231122100831718.png)

3. 配置允许访问的 IP，允许所有 IP 以 md5 方式访问

   ```bash
   $ vim /home/postgres/pgdata/pg_hba.conf
   host    all             all             0.0.0.0/0               md5
   ```

4. 启动数据库

   ```bash
   $ pg_ctl start
   $ pg_ctl stop
   $ pg_ctl restart
   ```

5. 修改数据库密码

   ```bash
   $ psql
   alter user postgres with password 'your password';
   ```

6. 退出 sql 命令行

   ```bash
   $ \q
   ```

如果想要暴露数据库到外面，需要修改 `postgresql.conf` 文件

```bash
$ vim /home/postgres/pgdata/postgresql.conf
listen_addresses = '0.0.0.0'
port = 5432
$ pg_ctl restart
```

之后再去云服务器把对应安全组放开，即可拿 sql 工具进行访问

- 连接之后就可以创建对应表、对应模式，之后执行初始化 sql 脚本了

### 安装Redis

去官网下载或者使用 wget 下载到指定目录

- [http://download.redis.io/releases/](http://download.redis.io/releases/)

## 前端环境搭建

### 安装Nvm

> [nvm Github](https://github.com/nvm-sh/nvm)

直接下载可能会超时，没超时按 Github 安装方法即可

```bash
$ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
```

git clone 下载，之后把环境变量添加到对应文件

```bash
$ git clone https://github.com/creationix/nvm.git ~/.nvm
# 在 ~/.zshrc、~/.profile、~/.bashrc 添加以下命令
$ echo "source ~/.nvm/nvm.sh" >> ~/.bashrc
$ echo "source ~/.nvm/nvm.sh" >> ~/.profile
```

安装依赖

```bash
$ npm i -g pnpm
```

前端打 jar 包添加如下脚本命令：

- 并添加对应 pom.xml 文件

```json
"scripts": {
  "mvn": "npm run build && mvn clean && mvn install"
}
```

## 自动化脚本

### 修改对应配置文件

首先需要核对配置文件是否符合需求

- 我这边需要修改对应 pg 配置和对应服务的端口

```bash
$ vim /home/template/ticket-base/ticket-base-run/src/main/resources/application-pg-dev.yml
db:
  url: ..
  username: ..
  password: ..
$ vim /home/template/ticket-base/ticket-base-run/src/main/resources/application.yml
server:
  port: 8080
```

### 自动打包程序脚本

编写自动打包脚本程序：`build.sh`

- 需要注意从 Windows 直接复制脚本程序还需要修改换行格式

```bash
$ vim build.sh
#!/bin/bash
# 前端打包
cd /home/template/ticket-base-ui
pnpm i
pnpm mvn
# 后端打包
cd /home/template/ticket-base
mvn clean install

$ chmod 755 build.sh
# Windows复制需要额外操作
$ vim build.sh
:set ff=unix
:wq
```

### 自动开启关闭程序脚本

编写自动杀进程、启动程序脚本

```bash
$ vim start.sh
#!/bin/bash
BASE=/home/template
FILE=ticket-base-1.0.0-SNAPSHOT.jar
# 删除历史数据
rm -rf $BASE/$FILE
# 数据包拷贝到指定位置
cp $BASE/ticket-base/ticket-base-run/target/$FILE $BASE/$FILE
PID=`ps -ef | grep ticket-base | grep 'java -jar' | awk '{printf $2}'`
# 如果pid为空，提示一下，否则，执行kill命令
if [ -z $PID ];
	then
		echo "java server not started"
	else
		kill -9 $PID
		echo "java server stoping...."
fi
# 启动程序
nohup java -jar $BASE/$FILE >/dev/null 2>&1 &
echo 'java server starting...'
```




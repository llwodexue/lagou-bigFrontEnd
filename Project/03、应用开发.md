## 项目目录

- main（主应用）
- platform（发布平台）
- react15
- react16
- service（服务端）
- vue2
- vue3
- package.json
- README.md

**同时启动所有项目**

```js
// node 执行命令的包
const childProcess = require('child_process')
// node 获取路径的包
const path = require('path')

const filePath = {
  vue2: path.resolve(__dirname, '../vue2'), // 获取根目录, 再连接
  vue3: path.resolve(__dirname, '../vue3'),
  react15: path.resolve(__dirname, '../react15'),
  react17: path.resolve(__dirname, '../react17'),
  // 添加启动service命令
  service: path.join(__dirname, '../service')
}
// cd 子应用目录 && npm start 启动项目
function runChild() {
  // 获取子应用的路径,  然后执行命令
  Object.values(filePath).forEach(item => {
    childProcess.spawn(`cd ${item} && npm start`, {
      // 执行shell脚本配置
      stdio: 'inherit',
      shell: true
    })
  })
}

// 运行子应用
runChild()
```

## vue2/3 项目

```js
const path = require('path')

function resolve(dir) {
  return path.join(__dirname, dir)
}
const packageName = 'packageName' // vue2 vue3
const port = 9080

module.exports = {
  outputDir: 'dist', // 打包的目录
  assetsDir: 'static', // 打包的静态资源
  filenameHashing: true, // 打包出来的文件，会带有hash信息
  publicPath: `http://localhost:${port}`,
  devServer: {
    contentBase: path.join(__dirname, 'dist'),
    hot: false,
    disableHostCheck: true,
    port,
    headers: {
      'Access-Control-Allow-Origin': '*' // 本地服务的跨域内容
    }
  },
  // 自定义webpack配置
  configureWebpack: {
    resolve: {
      alias: {
        '@': resolve('src')
      }
    },
    output: {
      // 把子应用打包成 umd 库格式 commonjs 浏览器，node环境
      libraryTarget: 'umd',
      filename: `${packageName}.js`,
      library: `${packageName}`, // 可以通过window.vue2 获取应用的内容
      jsonpFunction: `webpackJsonp_${packageName}`
    }
  }
}
```

## react

```js
const path = require('path')
const HtmlWebpackPlugin = require('html-webpack-plugin')
const MiniCssExtractPlugin = require('mini-css-extract-plugin')

const port = 9082
module.exports = {
  entry: {
    path: ['./index.js']
  },
  module: {
    rules: [
      {
        test: /\.js(|x)$/,
        use: {
          loader: 'babel-loader',
          options: {
            presets: ['@babel/preset-env', '@babel/preset-react']
          }
        }
      },
      {
        test: /\.(c|sc)ss$/,
        use: [MiniCssExtractPlugin.loader, 'css-loader', 'sass-loader']
      },
      {
        test: /\.(png|svg|jpg|gif)$/,
        use: {
          loader: 'url-loader'
        }
      }
    ]
  },
  optimization: {
    splitChunks: false,
    minimize: false
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: './public/index.html'
    }),

    new MiniCssExtractPlugin({
      filename: '[name].css'
    })
  ],
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'react15.js',
    library: 'react15',
    libraryTarget: 'umd',
    umdNamedDefine: true,
    publicPath: `http://localhost:${port}/`
  },
  devServer: {
    // 配置允许跨域
    headers: { 'Access-Control-Allow-Origin': '*' },
    contentBase: path.join(__dirname, 'dist'),
    compress: true,
    port: port,
    historyApiFallback: true,
    hot: true
  },
  performance: {
    //  就是为了加大文件允许体积，提升报错门槛。
    hints: 'warning', // 枚举
    maxAssetSize: 500000000, // 整数类型（以字节为单位）
    maxEntrypointSize: 500000000, // 整数类型（以字节为单位）
    assetFilter: function (assetFilename) {
      // 提供资源文件名的断言函数
      return assetFilename.endsWith('.css') || assetFilename.endsWith('.js')
    }
  }
}

```



## 构建后端服务

使用 supervisor 配置项目自动更新

```json
{
  "scripts": {
    "start": "supervisor bin/www",
    "dev": "./node_modules/.bin/nodemon bin/www",
    "prd": "pm2 start bin/www"
  }
}
```

配置 koa 跨域配置、路由中间件

```js
const Koa = require('koa')
const app = new Koa()

const json = require('koa-json')
const onerror = require('koa-onerror')
const bodyparser = require('koa-bodyparser')
const logger = require('koa-logger')

// 注册koa中间件
const cors = require('koa-cors') // 解决跨域
const index = require('./routes/index')
const users = require('./routes/users')

// 引入vue2的接口内容
const vue2 = require('./routes/vue2')
// 引入react17的接口内容
const react17 = require('./routes/react17')

// error handler
onerror(app)

// middlewares
app.use(
  bodyparser({
    enableTypes: ['json', 'form', 'text']
  })
)
app.use(json())
app.use(logger())
app.use(require('koa-static')(__dirname + '/public'))

// logger
app.use(async (ctx, next) => {
  const start = new Date()
  await next()
  const ms = new Date() - start
  console.log(`${ctx.method} ${ctx.url} - ${ms}ms`)
})

app.use(cors())

// routes
app.use(index.routes(), index.allowedMethods())
app.use(users.routes(), users.allowedMethods())
app.use(vue2.routes(), vue2.allowedMethods())
app.use(react17.routes(), react17.allowedMethods())

// error-handling
app.on('error', (err, ctx) => {
  console.error('server error', err, ctx)
})

module.exports = app
```

## 子应用接入微前端

**vue2**

```js
import Vue from 'vue'
import App from './App.vue'
import router from './router'

let instance = null // 定义对象接收实例
const render = () => {
  instance = new Vue({
    router,
    render: h => h(App)
  }).$mount('#app-vue')
}
if (!window.__MICRO_WEB__) {
  // 如果不是微前端环境,执行render
  render()
}

// 如果在微前端环境,暴露生命周期
export const bootstrap = () => {
  console.log('vue2开始加载')
}
export const mount = () => {
  console.log('vue2渲染成功')
  render()
}
export const unmount = () => {
  // 卸载时候卸载vue实例,卸载事件,清空当前根元素的内容
  console.log('vue2卸载', instance)
}
```

**vue3**

```js
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'

let instance = null
const render = () => {
  instance = createApp(App)
  instance.use(router).mount('#app')
}
if (!window.__MICRO_WEB__) {
  render()
}

export const bootstrap = () => {
  console.log('vue3开始加载')
}
export const mount = () => {
  console.log('vue3渲染成功')
  render()
}
export const unmount = () => {
  console.log('vue3卸载', instance)
}
```

**react15/17**

```js
import React from 'react'
import ReactDOM from 'react-dom'
import BasicMap from './src/router'

const render = () => {
  ReactDOM.render(<BasicMap />, document.getElementById('app-react'))
}
if (!window.__MICRO_WEB__) {
  render()
}

export const bootstrap = () => {
  console.log('react15开始加载')
}
export const mount = () => {
  console.log('react15渲染成功')
  render()
}
export const unmount = () => {
  console.log('react15卸载')
}
```




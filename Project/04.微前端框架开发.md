## 注册子应用

### 抽离导航

- `src\const\nav.js`

```js
export const NAV_LIST = [
  {
    name: '首页',
    status: true,
    value: 0,
    url: '/vue3/index',
    hash: ''
  },
  {
    name: '资讯',
    status: false,
    value: 1,
    url: '/react15/information',
    hash: ''
  },
  {
    name: '视频',
    status: false,
    value: 2,
    url: '/react15/video',
    hash: ''
  },
  {
    name: '选车',
    status: false,
    value: 3,
    url: '/vue3/select',
    hash: ''
  },
  {
    name: '新能源',
    status: false,
    value: 4,
    url: '/vue2/energy',
    hash: ''
  },
  {
    name: '新车',
    status: false,
    value: 5,
    url: '/react17/new-car',
    hash: ''
  },
  {
    name: '排行',
    status: false,
    value: 6,
    url: '/react17/rank',
    hash: ''
  }
]
```

使用路由进行跳转

- `src\router\index.js`

```js
import { createRouter, createWebHistory, createWebHashHistory } from 'vue-router'

const routes = [
  {
    path: '/',
    component: () => import('../App.vue')
  },
  {
    path: '/react15',
    component: () => import('../App.vue')
  },
  {
    path: '/react16',
    component: () => import('../App.vue')
  },
  {
    path: '/vue2',
    component: () => import('../App.vue')
  },
  {
    path: '/vue3',
    component: () => import('../App.vue')
  }
]

const router = (basename = '') =>
  createRouter({
    // history: createWebHashHistory(),
    history: createWebHistory(basename),
    routes
  })

export default router()
```

### 创建激活规则

- `src\store\sub.js`

```js
export const subNavList = [
  {
    name: 'react15', //子应用名称
    activeRule: '/react15', // 激活规则
    container: '#micro-container', // 显示的容器，唯一标识
    entry: '//localhost:9082/' // 启动的入口
  },
  {
    name: 'react17',
    activeRule: '/react17',
    container: '#micro-container',
    entry: '//localhost:9083/' // 启动的入口
  },
  {
    name: 'vue2',
    activeRule: '/vue2',
    container: '#micro-container',
    entry: '//localhost:9080/'
  },
  {
    name: 'vue3',
    activeRule: '/vue3',
    container: '#micro-container',
    entry: '//localhost:9081/'
  }
]
```

- `src\util\utils.js`

```js
import { MicroStart } from '../../micro'
const { registerMicroApps } = MicroStart

// 注册子应用
export const registerApp = list => {
  // 注册到微前端框架
  registerMicroApps(list)
}
```

- `src\main.js`

```js
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import { subNavList } from './store/sub'
// 主应用引入 util 方法
import { registerApp } from './util/utils'

registerApp(subNavList)

createApp(App).use(router).mount('#micro_web_main_app')
```

- `micro\const\subApps.js`

```js
let list = []

export const getList = () => list
export const setList = appList => (list = appList)
```

- `micro\start.js`

```js
import { setList } from './const/subApps'

export const registerMicroApps = appList => {
  // window.appList = appList
  setList(appList)
}
```

## 路由拦截

- `micro\router\rewriteRouter.js`

```js
import { patchRouter } from '../utils'
import { turnApp } from './routerHandle'

// 重写路由跳转： 实现路由拦截
export const rewriteRouter = () => {
  window.history.pushState = patchRouter(window.history.pushState, 'micro_push')
  window.history.replaceState = patchRouter(window.history.replaceState, 'micro_replace')

  window.addEventListener('micro_push', turnApp)
  window.addEventListener('micro_replace', turnApp)
  window.onpopstate = function () {
    turnApp()
  }
}
```

- `micro\utils\index.js`

```js
// 给当前路由跳转打补丁
export const patchRouter = (globalEvent, eventName) => {
  return function () {
    const e = new Event(eventName)
    globalEvent.apply(this, arguments)
    window.dispatchEvent(e)
  }
}
```

- `micro\router\routerHandle.js`

```js
export const turnApp = () => {
  console.log('路由切换了')
}
```

## 获取首个子应用

- `micro\utils\index.js`

```js
import { getList } from '../const/subApps'

export const currentApp = () => {
  const currentUrl = window.location.pathname
  return filterApp('activeRule', currentUrl)
}
// 过滤当前路由
const filterApp = (key, value) => {
  // 当前key值===value值
  const currentApp = getList().filter(item => item[key] === getCurrentPrefix())
  return currentApp && currentApp.length ? currentApp[0] : {}
}
const getCurrentPrefix = (value = window.location.pathname) => {
  const currentPrefix = value.match(/(\/\w+)/g)
  return currentPrefix && currentPrefix.length && currentPrefix[0]
}

// 子应用是否做了切换
export const isTurnChild = () => {
  if (window.__CURRENT_SUB_APP__ === getCurrentPrefix()) {
    return false
  }
  return true
}
```

- `micro\utils`

```js
import { isTurnChild } from '../utils'
// 每次路由切换打印事件
export const turnApp = () => {
  if (isTurnChild()) {
    console.log('路由切换了')
  }
}
```

- `micro\start.js`

```js
import { getList } from './const/subApps'
import { currentApp } from './utils'

// 启动微前端框架
export const start = () => {
  // 1. 获取当前子应用列表是否为空
  const apps = getList()
  if (!apps.length) {
    // 子应用列表为空
    throw Error('子应用列表为空， 请正确注册')
  }
  // 2. 有子应用内容，获取当前路由子应用
  const app = currentApp()

  if (app) {
    const { pathname, hash } = window.location
    const url = pathname + hash
    window.history.pushState('', '', url)

    window.__CURRENT_SUB_APP__ = app.activeRule
  }
}
```

## 主应用生命周期

- `src\util\index.js`

```js
import { MicroStart } from '../../micro'
import { loading } from '../store'
const { registerMicroApps, start } = MicroStart

// 注册子应用
export const registerApp = list => {
  // 注册到微前端框架
  registerMicroApps(list, {
    beforeLoad: [
      () => {
        loading.changeLoading(true)
        console.log('开始加载')
      }
    ],
    mounted: [
      () => {
        loading.changeLoading(false)
        console.log('渲染完成')
      }
    ],
    destoryed: [
      () => {
        console.log('卸载完成')
      }
    ]
  })

  // 启动微前端框架
  start()
}
```

- `micro\const\mainLifeCycle.js`

```js
let lifeCycle = {}

export const getMainLifecycle = () => lifeCycle
export const setMainLifecycle = data => (lifeCycle = data)
```

- `micro\start.js`

```js
import { setMainLifecycle } from './const/mainLifeCycle'
import { setList, getList } from './const/subApps'

const registerMicroApps = (appList, lifeCycle) => {

  setList(appList)

  lifeCycle.beforeLoad[0]()

  setTimeout(() => {
    // 3s后隐藏loading
    lifeCycle.mounted[0]()
  }, 3000)
  // 缓存生命周期
  setMainLifecycle(lifeCycle)
}
```

- `src\store\loading.js`

```js
import { ref } from 'vue'

export let loadingStatus = ref(true)
export const changeLoading = type => (loadingStatus.value = type)
```


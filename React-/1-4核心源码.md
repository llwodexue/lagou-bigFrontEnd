## 配置 React 源码本地调试环境

1. 使用 create-react-app 脚手架创建项目

   ```bash
   npx create-react-app react-test
   ```

2. 弹射 create-react-app 脚手架内部配置

   ```bash
   npm run eject
   ```

3. 克隆 react 官方源码 (在项目的根目录下进行克隆)

   ```bash
   git clone --branch v16.13.1 --depth=1 https://github.com/facebook/react.git src/react
   ```

4. 链接本地源码

   `config\webpack.config.js`

   ```json
   resolve: {
     alias: {
       'react-native': 'react-native-web',
       react: path.resolve(__dirname, '../src/react/packages/react'),
       'react-dom': path.resolve(__dirname, '../src/react/packages/react-dom'),
       shared: path.resolve(__dirname, '../src/react/packages/shared'),
       'react-reconciler': path.resolve(
         __dirname,
         '../src/react/packages/react-reconciler'
       ),
       'legacy-events': path.resolve(__dirname, '../src/react/packages/legacy-events')
     }
   }
   ```

5. 修改环境变量

   `config\env.js`

   ```js
   const stringified = {
     'process.env': Object.keys(raw).reduce((env, key) => {
       env[key] = JSON.stringify(raw[key])
       return env
     }, {}),
     __DEV__: true,
     SharedArrayBuffer: true,
     spyOnDev: true,
     spyOnDevAndProd: true,
     spyOnProd: true,
     __PROFILE__: true,
     __UMD__: true,
     __EXPERIMENTAL__: true,
     __VARIANT__: true,
     gate: true,
     trustedTypes: true
   }
   ```

6. 告诉 babel 在转换代码时忽略类型检查

   ```bash
   npm i @babel/plugin-transform-flow-strip-types -D
   ```

   `config\webpack.config.js`

   ```js
   plugins: [
     require.resolve('@babel/plugin-transform-flow-strip-types')
   ]
   ```

7. 导出 HostConfig

   `src\react\packages\react-reconciler\src\ReactFiberHostConfig.js`

   ```js
   export * from './forks/ReactFiberHostConfig.dom';
   // invariant(false, 'This module must be shimmed by a specific renderer.');
   ```

8. 修改 ReactSharedInternals.js 文件

   `src\react\packages\shared\ReactSharedInternals.js`

   ```js
   // import * as React from 'react';
   
   // const ReactSharedInternals =
   //   React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;
   import ReactSharedInternals from '../react/src/ReactSharedInternals';
   ```

9. 关闭 eslint 扩展

   `src\react\.eslintrc.js`

   ```js
   module.exports = {
     // extends: [
     //   'fbjs',
     //   'prettier'
     // ],
   }
   ```

10. 禁止 invariant 报错

    `src\react\packages\shared\invariant.js`

    ```js
    export default function invariant(condition, format, a, b, c, d, e, f) {
      if (condition) return;
      throw new Error(
        'Internal React error: invariant() is meant to be replaced at compile ' +
          'time. There is no runtime version.',
      );
    }
    ```

11. eslint  配置

    新建 `src\react\.eslintrc.json`

    ```json
    {
      "extends": "react-app",
      "globals": {
        "SharedArrayBuffer": true,
        "spyOnDev": true,
        "spyOnDevAndProd": true,
        "spyOnProd": true,
        "__PROFILE__": true,
        "__UMD__": true,
        "__EXPERIMENTAL__": true,
        "__VARIANT__": true,
        "gate": true,
        "trustedTypes": true
      }
    }
    ```

12. 修改 react react-dom 引入方式

    ```js
    import * as React from "react"
    import * as ReactDOM from "react-dom"
    ```

13. 解决 vscode 中 flow 报错

    ```json
    {
    	"javascript.validate.enable": false
    }
    ```

14. `__DEV__` 报错

    删除 node_modules 文件夹，执行 npm install

## 创建 React 元素

JSX 被 Babel 编译为 React.createElement 方法的调用，createElement 方法在调用后返回的就是 ReactElement，就是 virtualDOM
# k8s集群部署

前提：所有机器安装 Docker

> [【云原生】2.2 kubeadm创建集群](https://blog.csdn.net/aasd23/article/details/125350494?spm=1001.2014.3001.5502)

## k8s基础环境

安装要求：

- 一台兼容的 Linux 主机。Kubernetes 项目为基于 Debian 和 Red Hat 的 Linux 发行版以及一些不提供包管理器的发行版提供通用的指令
- 每台机器 2GB 或更多的 RAM（如果少于这个数字将会影响你应用的运行内存）
- 2 CPU 核或更多
- 集群中的所有机器的网络彼此均能相互连接（公网和内网都可以）
  - **设置防火墙放行规则**
- 节点之中不可以有重复的主机名、MAC 地址或 product_uuid
  - **设置不同hostname**
- 开启机器上的某些端口
  - **内网互信**
- 禁用交换分区。为了保证 kubelet 正常工作，你必须禁用交换分区
  - **永久关闭**

各个机器设置自己的主机名

```bash
$ hostnamectl set-hostname k8s-master
```

将 SELinux 设置为 permissive 模式（相当于将其禁用）

```bash
# 临时禁用
$ setenforce 0
# 永久禁用
$ sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
```

关闭 swap

```bash
# 以MB为单位显示内存使用情况
$ free -m
              total        used        free      shared  buff/cache   available
Mem:           1888        1672          82           3         134          77
Swap:             0           0           0
# 如果swap不为0，需要关闭
# 临时禁用
$ swapoff -a
# 永久禁用
$ sed -ri 's/.*swap.*/#&/' /etc/fstab
```

转发 IPv4 并让 iptables 看到桥接流量

> [Container Runtimes](https://kubernetes.io/docs/setup/production-environment/container-runtimes/)

```bash
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

# 应用 sysctl 参数而不重新启动
sudo sysctl --system
```

## 安装kubelet、kubeadm、kubectl

配置集群 k8s 下载

```bash
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF
```

安装

```bash
$ yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes
```

kubelet 现在每隔几秒就会重启，因为它陷入了一个等待 kubeadm 指令的死循环

```bash
$ systemctl enable --now kubelet
```

## 使用kubeadm引导集群

1. 下载各个机器需要的镜像

   ```bash
   sudo tee ./images.sh <<-'EOF'
   #!/bin/bash
   images=(
   kube-apiserver:v1.20.9
   kube-proxy:v1.20.9
   kube-controller-manager:v1.20.9
   kube-scheduler:v1.20.9
   coredns:1.7.0
   etcd:3.4.13-0
   pause:3.2
   )
   for imageName in ${images[@]} ; do
   docker pull registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/$imageName
   done
   EOF
   ```

   ```bash
   chmod +x ./images.sh && ./images.sh
   ```

2. 初始化主节点

   所有机器添加master域名映射，以下需要修改为自己的

   **注意：**所有机器添加 master 域名映射，以下需要修改为自己的

   ```bash
   echo "172.16.0.2  k8s-master" >> /etc/hosts
   ```

   主节点初始化

   ```bash
   kubeadm init \
   --apiserver-advertise-address=172.16.0.2 \
   --control-plane-endpoint=k8s-master \
   --image-repository registry.aliyuncs.com/google_containers \
   --kubernetes-version v1.20.9 \
   --service-cidr=10.96.0.0/16 \
   --pod-network-cidr=192.168.0.0/16
   ```

3. 根据提示继续

   看到以下信息，说明 master 节点初始化成功

   ```bash
   Your Kubernetes control-plane has initialized successfully!
   
   To start using your cluster, you need to run the following as a regular user:
   
     mkdir -p $HOME/.kube
     sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
     sudo chown $(id -u):$(id -g) $HOME/.kube/config
   ```

4. 设置 .kube/config（在主节点）

   ```bash
   mkdir -p $HOME/.kube
   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
   sudo chown $(id -u):$(id -g) $HOME/.kube/config
   ```

5. 安装网络组件（在主节点）

   ```bash
   curl https://docs.projectcalico.org/manifests/calico.yaml -O
   kubectl apply -f calico.yaml
   ```

6. 测试

   ```bash
   # 查看集群所有节点
   kubectl get nodes
   
   # 根据配置文件，给集群创建资源
   kubectl apply -f xxxx.yaml
   
   # 查看集群部署了哪些应用？
   docker ps   ===   kubectl get pods -A
   
   # 运行中的应用在docker里面叫容器，在k8s里面叫Pod
   kubectl get pods -A
   ```

   等待 calio 处于 running 状态在进行下一步

7. 加入 node 节点

   ```bash
   kubeadm join cluster-endpoint:6443 --token jk4doc.9vp0o7io7a0wta49 --discovery-token-ca-cert-hash sha256:2ebfb444f0706564a09b531d611e9f1c6d0089e427ce1fe295b666be03513f72
   ```

   获取新新令牌

   ```bash
   kubeadm token create --print-join-command
   ```

8. 部署 dashboard

   kubernetes 官方提供的可视化界面：[https://github.com/kubernetes/dashboard](https://github.com/kubernetes/dashboard)

   ```bash
   wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml
   ```

9. 修改 recommended.yaml，修改内容，在 deployment 增加 nodeName: k8s-master，指定安装在主节点，修改 service：ClusterIP 改为 type: NodePort

   - 如果命令没有用，我们就直接将 [https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml](https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml) 粘贴过来

10. 设置访问端口

    ```bash
    kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
    # /type: 按回车
    # ClusterIP 改为 type: NodePort
    ```

    找到端口，在安全组放行

    ```bash
    kubectl get svc -A |grep kubernetes-dashboard
    ```

    之后就可以访问对应地址加端口号进入页面了

11. 获取访问令牌

     ```bash
    kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath="{.secrets[0].name}") -o go-template="{{.data.token | base64decode}}"
     ```




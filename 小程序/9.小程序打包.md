# 小程序打包

## 分包处理

点击详情，查看代码依赖分析

![image-20240418112403362](https://gitee.com/lilyn/pic/raw/master/md-img/image-20240418112403362.png)

在构建小程序分包项目时，构建会输出一个或多个分包。每个使用分包小程序必定含有一个**主包**

- 所谓的主包，即放置默认启动页面/TabBar 页面，以及一些所有分包都需用到公共资源/JS 脚本；而**分包**则是根据开发者的配置进行划分

![image-20240418112434908](https://gitee.com/lilyn/pic/raw/master/md-img/image-20240418112434908.png)

目前小程序分包大小有以下限制：

- 整个小程序所有分包大小不超过 20M（开通虚拟支付后的小游戏不超过30M）
- 单个分包/主包大小不能超过 2M

**打包原则**

- 声明 `subpackages` 后，将按 `subpackages` 配置路径进行打包，`subpackages` 配置路径外的目录将被打包到主包中
- 主包也可以有自己的 pages，即最外层的 pages 字段。
- `subpackage` 的根目录不能是另外一个 `subpackage` 内的子目录
- `tabBar` 页面必须在主包内

开发者通过在 app.json `subpackages` 字段声明项目分包结构：

![image-20240418142517134](https://gitee.com/lilyn/pic/raw/master/md-img/image-20240418142517134.png)

添加 `subpackages` 字段指定分包

![image-20240418142550629](https://gitee.com/lilyn/pic/raw/master/md-img/image-20240418142550629.png)

再看代码依赖分析就能看到主包大小减少了

![image-20240418150917041](https://gitee.com/lilyn/pic/raw/master/md-img/image-20240418150917041.png)

## 依赖被打到哪里去

如果主包和分包同时使用了一个依赖

- 因为主包不能引用分包的资源，但是子包可以引用主包的资源，所以为了两个包都能引用到资源，只能打到主包中

如果某一个依赖只在分包中使用

- 就会打入当前分包

两个分包使用了同一个依赖或资源

- 该依赖和资源会被打入到主包

由微信后台编译来处理旧版本客户端的兼容，后台会编译两份代码包，一份是分包后代码，另外一份是整包的兼容代码。 新客户端用分包，老客户端还是用的整包，完整包会把各个 `subpackage` 里面的路径放到 pages 中。所以分包无需担心版本的兼容问题

## 独立分包

因为独立分包不需要依赖主包，如果有作为打开小程序的的入口的必要，加载速度会比普通分包快，给客户的体验感更好。毕竟谁也不想打开一个页面等半天

- 如果小程序启动的时候是打开一个普通分包页面。则加载顺序是：**加载主包 => 再加载当前分包**

**配置和普通分包一样**，加一个 **independent** 属性设为 true 即可

![image-20240418151843533](https://gitee.com/lilyn/pic/raw/master/md-img/image-20240418151843533.png)

既然独立分包可以不依赖主包，那我把每个分包都打成独立分包可以吗？最好别这么干

1. 独立分包因为不依赖主包，所以他不一定能获取到小程序层面的全局状态，比如 getApp().也不是完全获取不到，主包被加载的时候还是可以获取到的。概率性出问题，最好别用
2. 独立分包不支持使用插件
3. 小程序的公共文件不适用独立分包。比如 Taro 的 app.less 或小程序的 app.wxss

## 分包预下载

分包是基本功能是，在下载程序打包的时候不去加载分包，然后在进入当前分包页面的时候才开始下载分包。一方面目的是为了加快小程序的响应速度。另一方面的原因是避开微信小程序本身只能上传2M的限制

这里有一个问题，就是我在首次跳转某个分包的某个页面的时候，出现短暂的白屏怎么办？（下载分包的时间+运行接口的时间+渲染视图的时间）

这时候就可以使用分包预下载
## 13. 强缓存与协商缓存

HTTP 缓存分为以下两种，两者都是通过 HTTP 响应头控制缓存

1. 强制缓存

   通过响应头 `Cache-Control` 中 `max-age` 指令进行控制，`max-age` 可设置强缓存时间周期，在该周期内将直接从客户端缓存获取资源，而不会向服务器发送请求

2. 协商缓存

   通过响应头 `ETag` 与 `Last-Modified` 进行控制，它每次发送请求时，需要进行缓存新鲜度校验，如果资源过久，将从响应中获取，否则从客户端缓存中获取

   新鲜度校验通过请求头 `If-None-Match` 与响应头 `ETag` 进行对比，或请求头 `If-Modified-Since` 与响应头 `Last-Modified` 进行对比

一般来说，我们对经构建工具打包后，带有 hash 的资源进行一年的强缓存，而对不带 hash 的资源进行协商缓存控制

- 需要设置 `Cache-Control: max-age=0/no-cache`
- 否则会根据 Date 与 `Last-Modified` 计算出强缓存时间

**强制缓存**

- 再次请求时无需再向服务器发送请求

```bash
          client         server
GET /a.ab389z.js ------->
                <------- 200 OK
(再也不会发请求)
```

与之相关的 Response Headers 有以下几个

- `Expires`

  这个头使用绝对时间，且有固定格式：`  Expires: Mon, 25 Oct 2021 20:11:12 GMT`

- `Cache-Control` 常用以下两个

  - `no-cache` 每次请求需要校验服务器的资源新鲜度
  - `max-age=31536000` 浏览器在一年内都不需要向服务器请求资源

**协商缓存**

再次请求时，需要向服务器校验新鲜度，如果资源是新鲜的，返回 304，从浏览器获取资源

```bash
           client         server
GET /a.js   ----------->
                   <----------- 200 OK
GET /a.js   ----------->
                   <----------- 304 Not Modified
```

与之相关的 Request/Response Headers 有以下几个

- `Last-Modified`/`If-Modified-Since`，匹配 Response Header 的 `Last-Modified` 与 Request Header 的 `If-Modified-Since` 是否一致
- `Etag`/`If-None-Match`，匹配 Response Header 的 `Etag` 与 Request Header 的 `If-None-Match` 是否一致

**作业**

1. 什么是强缓存和协商缓存
2. 如何验证网站某资源添加了强缓存
3. 协商缓存如何校验新鲜度

与之相关的 Request/Response Headers 有以下几个

- `Last-Modified`/`If-Modified-Since`，匹配 Response Header 的 `Last-Modified` 与 Request Header 的 `If-Modified-Since` 是否一致
- `Etag`/`If-None-Match`，匹配 Response Header 的 `Etag` 与 Request Header 的 `If-None-Match` 是否一致

## 14. 强缓存与 age/max-age

![image-20221026151542192](E:\learn\lagouBigFront\md\HTTP\img\image-20221026151542192.png)

一条 HTTP 响应，从源服务器到客户端需要经过多个 Proxy，包括 Nginx 反向代理、CDN 等

- 注意：一条 HTTP 响应报文会经历从源服务器到客户端，其中某些响应头由源服务器控制生成，而某些响应头由 CDN 控制生成
- 在这个过程中，在源服务器配置的某些请求头比如 `Cache-Control`，也将会在 CDN 生效。因此长期缓存的意义不仅仅在客户端，更在 CDN 上

比如：某一条配置了一年长期缓存的资源为 `main.abcxyz.js`

- 身在太原的用户甲，访问该请求，由于该请求是第一次被太原的用户访问，该请求将从源服务器中获取，并缓存在太原的 CDN 节点一年时间。请求成功后，该请求在浏览器进行一年的强缓存，一年之内将可利用浏览器的缓存，不会对该资源发起实际请求
- 身在太原的用户乙，访问该请求，由于身在同一城市的用户甲已访问过，直接从太原的 CDN 节点获取数据，将比直接通过源服务器请求数据拥有更快的速度

如果 CDN 节点关于该请求的缓存到期，当用户发起请求时，CDN 节点将又会直接从源服务器获取资源，这个过程叫做回源

**max-age/age**

如果某条资源强缓存一年时间，在客户端向该资源发起请求时，该资源刚好还有一天时间到期，但是在客户端又接收到了 `Cache-Control` 强缓存一年的配置，那该资源岂不是被缓存了两年？

- 其实，这是不可能发生的情况，它与一个**由代理服务器产生的响应头**有关

  `age`：HTTP 资源在代理服务器中的存储时间，以秒为单位。由代理服务器产生，而非服务器产生

```bash
# 该资源仅仅只会缓存 10 秒
age: 90
cache-control: max-age=100
```

通过 `HTTP Server`，配置以下响应头。代码见 [http/index.js](https://github.com/shfshanyue/node-examples/blob/master/http/index.js)

```js
// 服务器代码
const http = require('http')
const server = http.createServer((req, res) => {
  const routes = {
    '/': () => {
      res.end('hello, world')
    },
    '/cache': () => {
      res.setHeader('cache-control', 'max-age=100')
      res.setHeader('age', '90')
      res.end('Cache 100s')
    }
  }
  for (const [path, handle] of Object.entries(routes)) {
    if (req.url === path) {
      handle()
    }
  }
})
server.listen(3003, () => {
  console.log('Listening: http://localhost:3003')
})


// 客户端代码
const sleep = n => new Promise(resolve => setTimeout(resolve, n))
for (let i = 0; i < 100; i++) {
  await fetch('/cache')
  await sleep(2000)
}
```

由于是每两秒发送一次请求，则预期每五次便会发送一次真正的请求，以下是测试结果，与预期一致

![image-20221026154144724](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20221026154144724.png)

**作业**

1. 使用 Node.js 写一段服务器代码测试 age/max-age

2. age/max-age 的作用是什么

   - `age` 是 response header: 代表 HTTP 资源在代理服务器中的存储时间，以秒作为单位。由代理服务器产生，而非源服务器产生

   - `max-age` 是 response header `cache-control` 的值，代表设置缓存存储的最大周期，超过这个时间缓存被认为过期 (单位秒)。与`Expires` 相反，时间是相对于请求的时间

## 15. 启发式缓存

当对某资源没有配置 `Cache-Control` 响应头时，客户端将会根据以下两个响应头**计算出合适的强缓存时间**，被称为启发式缓存

- `Date`: HTTP 报文在源服务器的产生时间
- `Last-Modified`: 源服务器上资源的上次修改时间

还有一个相关参数，称为 `LM-Factor` 与它俩有关，它处于 `[0, 1]` 之间，以下使用 n 来替代

- 一个静态资源没有设置 `Cache-Control` 响应头时会以这两个响应头来设置强制缓存时间：`(Date - LastModified) * n`，而非直接进行协商缓存
- 在涉及到 CDN 时，表现更为明显，如果对 `index.html` 没有配置 `Cache-Control` 响应头时，体现在更新代码部署后，界面没有更新，这是一个非常严重的问题



![image-20221026165150461](https://gitee.com/lilyn/pic/raw/master/lagoulearn-img/image-20221026165150461.png)

**作业**

1. 什么是启发式缓存

   下面这个资源生成时间是 2021/02/22， 最近一次更改是 2022/02/22，意味着时间差为 1 年。那么客户端一般会采用 `LM-Factor -> 0.1` 来缓存该资源，即 0.1 年

   ```bash
   HTTP/1.1 200 OK
   Content-Type: text/html
   Content-Length: 1024
   Date: Tue, 22 Feb 2022 22:22:22 GMT
   Last-Modified: Tue, 22 Feb 2021 22:22:22 GMT
   ```

2. 你们有过部署代码后页面无更新，且强制刷新不生效的案例吗

## 16. 协商缓存响应头生成算法

针对静态资源而言，一般会选择文件的 `mtime` 元属性作为上次修改时间，该元属性表示文件内容的修改时间